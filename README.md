# ITS Extensions

## Развертывание

### 1. Подготовьте инфраструктуру Yandex Cloud
1. Создайте сервисный аккаунт с ролями: ```storage.viewer```, ```storage.uploader```, ```storage.editor``` (или примитивную роль `editor`)

2. Cоздайте в нём статический ключ доступа. 
Сохраните идентификатор и секретный ключ в соответствующие поля файла `deploy-scripts/.env` или `deploy-scripts/.env.local`
```
ACCESS_KEY_ID="<ключ доступа>"
SECRET_ACCESS_KEY="<секретный ключ>"
...
```
3. Установите и настройте [Yandex Cloud CLI](https://cloud.yandex.ru/docs/cli/quickstart)
4. Установите пакеты для скрипта подготовки инфраструктуры
 - ```cd deploy-script```
 - ```npm install```
5. Проверьте остальные константы в файле `.env` или `.env.local` (настройки `.env.local` имеют больший приоритет)

6. Выполните скрипт подготовки инфраструктуры
 - ```node deploy.js```

### 2. Настройте Bucket
1. Перейдите в Object storage в раздел Настройки только что созданного бакета из `.env` или `.env.local`
2. Укажите `Публичный` доступ для настроек:
  - Доступ на чтение объектов
  - Доступ к списку объектов

### 3. Настройте Политику доступа созданного Бакета
1. Перейдите в пункт "Политика доступа"
2. Нажмите на кнопку "Настроить доступ" в верхнем правом углу
#### Консоль
1. Создайте правило для консоли, нажав  "Добавить правило для доступа из консоли"
#### Сервисный аккаунт
1. Создайте правило для сервисного аккаунта, нажав "Добавить правило"
1. Укажите пользователя - сервисный аккаунт
1. Укажите Дейсвтия (или выберите "Все действия"):
 - ListBucket
 - PutObject
 - GetObject
1. Укажите Ресурсы:
  - <название Бакета>/*
  - <название Бакета>
#### Остальные пользователи
Также возможно создать правило с доступом на чтение для всех пользователей
1. Создайте правило для сервисного аккаунта, нажав "Добавить правило"
1. Выберите пользователей:
   - Все пользователи
1. Укажите Дейсвтия:
   - ListBucket
   - GetObject
1. Укажите Ресурсы:
  - <название Бакета>/*
  - <название Бакета>

### 4. Настройте Веб-сайт Бакета
1. Выберите тип "Хостинг"
2. Укажите главную страницу index.html (нужно для переадресации)
3. Добавьте правило переадресации
4. Укажите доменное имя = доменное имя созданного API-Gateway (можно узнать в "Обзор" API-Gateway)
5. Если нужно, добавьте файл index.html с инструкцией использования сервиса в корень Бакета

### 5. Создайте и загрузите сборку сайта, выполнив команды:
1. Проверьте указанный адрес прокси в ```its_ext\src\utils\constants.ts```
    ```
    export const PROXY_URL = "https://<домен API-Gateway>/proxy";
    ```
2. Соберите проект сайта:
  - ```cd its_ext```
  - ```npm run build```

3. Обновите содержимое папки website в Бакете:
  - ```cd deploy-script```
  - ```npm run sync```

<br />

---

## Локальный запуск

1. Проверьте адрес прокси к npm в .npmrc (если прокси не требуется, следует удалить файл .npmrc)
2. Установите зависимости для проектов proxy, proxy-function, its_ext
  - ```cd proxy && npm install && cd ..```
  - ```cd proxy-function && npm install && cd ..```
  - ```cd its_ext && npm install && cd ..```

Ожидается, что приложение будет запущено на http://localhost:3001, если это не так, измените url в файле proxy/server.js в настройках cors

3. Запустите proxy
  - ```cd proxy && npm run start```
4. Запустите приложение
  - ```cd its_ext && npm run start```
5. Измените адрес прокси в ```its_ext\src\utils\constants.ts```
    ```
    export const PROXY_URL = "http://localhost:3000/proxy";
    ```

    TODO: Избавиться от этого пункта инструции. Определять, что приложение запущено локально и подменять PROXY_URL автоматически.

    
